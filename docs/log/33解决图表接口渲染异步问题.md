# 33 解决图表接口渲染异步问题

## 封装接口，方便useChart调用
1. 修改src/views/dashboard/Dashboard.vue文件,封装setLineChartData方法
```ts
async function setLineChartData() {
  let option = reactive({
    title: {
      text: "电量统计",
      textStyle: {
        fontSize: 14,
      },
    },
    tooltip: {
      trigger: "axis",
    },
    legend: {
      data: [],
    },
    xAxis: {
      type: "category",
      boundaryGap: false,
      data: [
        "13:00",
        "14:00",
        "15:00",
        "16:00",
        "17:00",
        "18:00",
        "19:00",
        "20:00",
        "21:00",
      ],
    },
    yAxis: {
      type: "value",
      axisLabel: {
        formatter: "{value} kw",
      },
    },
    series: [
      {
        name: "充电量",
        type: "line",
        smooth: true,
        data: [],
        lineStyle: {
          width: 3,
        },
        itemStyle: {
          color: "purple",
          shadowBlur: 3,
          shadowColor: "rgba(0,255,0,0.5)",
        },
      },
      {
        name: "充电时长",
        type: "line",
        smooth: true,
        data: [],
        lineStyle: {
          width: 3,
        },
        itemStyle: {
          color: "lightgreen",
          shadowBlur: 3,
          shadowColor: "rgba(0,255,0,0.5)",
        },
      },
      {
        name: "充电功率",
        type: "line",
        smooth: true,
        data: [],
        lineStyle: {
          width: 3,
        },
        itemStyle: {
          color: "skyblue",
          shadowBlur: 3,
          shadowColor: "rgba(0,255,0,0.5)",
        },
      },
    ],
  });
  interface chartData {
    name:string;
    data:number[];
  }
  let result = await getChartData();
  const list = result.list;
  option.legend.data = list.map((item) => item.name);
  option.series = option.series.map(
    (item, index) => {
      item.data = list[index]["data"];
      return item;
    }
  );
  return option;
}
useChart(chartRef, setLineChartData);
```
2. 修改src/hooks/useChart.ts方法
```ts
export function useChart(chartRef:Ref<HTMLElement|null>,setChartData:any){
    const chartInstance = ref<echarts.ECharts|null>(null);
    // const chartOptions = ref(initialOptions);

    const initChart = async () => {
        if(chartRef.value){
            // 初始化实例
            chartInstance.value = markRaw(echarts.init(chartRef.value));
            const result = await setChartData();
            chartInstance.value.setOption(result);
        }
    }

    const resizeChart =  () => {
        chartInstance.value?.resize();
    }

    onMounted(()=>{
        initChart();
        window.addEventListener("resize", resizeChart);
    })

    onBeforeUnmount(()=>{
        window.removeEventListener("resize", resizeChart);
        // 释放图表能占用的资源：图表实例
        if(chartInstance.value){
            // 如果图表实例还在，释放图表所占用的资源
            chartInstance.value.dispose(); 
        }
    })

}
```

## 知识点

### async和await
- async默认返回值是Promise，await可以取出Promise中的值，也就是Promise.resove(value)中的value值
- await会阻塞线程，暂停执行。